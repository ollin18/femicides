<!DOCTYPE html>
<meta charset="utf-8">
<style>

@import url(https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300|Josefin+Slab|Arvo|Lato|Vollkorn|Abril+Fatface|Old+Standard+TT|Droid+Sans|Lobster|Inconsolata|Montserrat|Playfair+Display|Karla|Alegreya|Libre+Baskerville|Merriweather|Lora|Archivo+Narrow|Neuton|Signika|Questrial|Fjalla+One|Bitter|Varela+Round);

.background {
  fill: #eee;
  pointer-events: all;
}

.map-layer {
  fill: #fff;
  stroke: #aaa;
}

.effect-layer{
  pointer-events:none;
}

text{
  font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  font-weight: 300;
}

text.big-text{
  font-size: 20px;
  font-weight: 400;
}

.effect-layer text, text.dummy-text{
  font-size: 12px;
}

</style>
<body>

<svg></svg>

<script src="https://d3js.org/d3.v3.min.js"></script>
<script>

var width = 1080,
    height = 720,
    centered;

// Define the array for the names
var namesF = [];
var femLon = [];
var femLat = [];

// Define color scale
var color = d3.scale//.linear()
  .pow().exponent(0.5)
  .clamp(true)
  .domain([0, 424])
  .range([d3.rgb('#cce6cd'), d3.rgb('#004303')])
  .nice();


var mexCent = [-101.5, 24.5]

var projection = d3.geo.mercator()
  .scale(1500)
  // Center the Map in Mexico
  .center(mexCent)
  .translate([width / 2, height / 2]);

var path = d3.geo.path()
  .projection(projection);

// Set svg width & height
var svg = d3.select('svg')
  .attr('width', width)
  .attr('height', height);

// Add background
svg.append('rect')
  .attr('class', 'background')
  .attr('width', width)
  .attr('height', height)
  .on('click', clicked);

var g = svg.append('g');

var effectLayer = g.append('g')
  .classed('effect-layer', true);

var mapLayer = g.append('g')
  .classed('map-layer', true);

var dummyText = g.append('text')
  .classed('dummy-text', true)
  .attr('x', 10)
  .attr('y', 30)
  .style('opacity', 0);

var bigText = g.append('text')
  .classed('big-text', true)
  .attr('x', width/2-80)
  .attr('y', 150);

var titleLayer = g.append('text')
    .attr('x', width/2-80)             
    .attr('y', 70)
    .attr('text-anchor', "middle")  
    .style("font-size", "35px") 
    .style("font-weight", "900") 
    .style('font-family', 'Josefin Slab')
    .text("MÃ©xico Feminicida");

var subtitleLayer = g.append('text')
    .attr('x', width/2-80)             
    .attr('y', 95)
    .attr('text-anchor', "middle")  
    .style("font-size", "20px") 
    .style("font-weight", "500") 
    .style('font-family', 'Josefin Slab')
    .text("(2015-2019)");

var paliacateLayer = g.append("svg:image")
    .attr('x', width-140)
    .attr('y', 25)
    .attr('width', 90)
    .attr('height', 90)
    .attr("xlink:href", "pal_verde.png")

// Load map data
d3.json('mexico_pret.json', function(error, mapData) {
  var features = mapData.features;

  // Update color scale domain based on data
  color.domain([d3.min(features, fem_num), d3.max(features, fem_num)]);

  // Draw each State as a path
  mapLayer.selectAll('path')
      .data(features)
      .enter().append('path')
      .attr('d', path)
      .attr('vector-effect', 'non-scaling-stroke')
      .style('fill', fillFn)
      .on('mouseover', mouseover)
      .on('mouseout', mouseout)
      .on('click', clicked);


// center cross x-5, y-6
d3.csv("monthly.csv", function(error, data) {
        g.selectAll("g")
           .data(data.slice(0,100))
           .enter()
           .append("svg:image")
           .attr("x", function(d) {
                   return projection([d.lon, d.lat])[0]-5;
           })
           .attr("y", function(d) {
                   return projection([d.lon, d.lat])[1]-6;
           })
           .attr('width',15)
           .attr('height',14)
            // .attr('width', function(d){
            //     return d.count*15})
            // .attr('height', function(d){
            //     return d.count*14})
            .attr("xlink:href", "pink_cross.svg")
        });

});


// Get State name
function nameFn(d){
  return d && d.properties ? d.properties.name : null;
}

// Get femicides number
function femFn(d){
  return d && d.properties ? d.properties.femicides : null;
}

// Get femicides number
function fem_num(d){
    var n = femFn(d);
    return n
}

// Get State color
function fillFn(d){
  return color(d.properties.femicides);
}

// When clicked, zoom in
function clicked(d) {
  var x, y, k;

  // Compute centroid of the selected path
  if (d && centered !== d) {
    var centroid = path.centroid(d);
    x = centroid[0];
    y = centroid[1];
    k = 4;
    centered = d;
  } else {
    x = width / 2;
    y = height / 2;
    k = 1;
    centered = null;
  }

  // Highlight the clicked province
  mapLayer.selectAll('path')
    .style('fill', function(d){return centered && d===centered ? '#8a0303' : fillFn(d);});

  // Zoom
  g.transition()
    .duration(750)
    .attr('transform', 'translate(' + width / 2 + ',' + height / 2 + ')scale(' + k + ')translate(' + -x + ',' + -y + ')');
}

function mouseover(d){
  // Highlight hovered province
  d3.select(this).style('fill', '#8a0303');

  // Draw effects
  textState(nameFn(d)+" - "+d.properties.femicides.toString());
    d3.csv("nombres_mexico.csv", function(csv){
        csv.map(function(d){
                namesF.push(d.NOMBRE);
        });
      textArt(d3.shuffle(namesF).slice(0,d.properties.femicides))
    });
}

function mouseout(d){
  // Reset State color
  mapLayer.selectAll('path')
    .style('fill', function(d){return centered && d===centered ? '#D5708B' : fillFn(d);});

  // Remove effect text
  effectLayer.selectAll('text').transition()
    .style('opacity', 0)
    .remove();

  // Clear State name
  bigText.text('');
}

// Gimmick
// Just me playing around.
// You won't need this for a regular map.

var BASE_FONT = "'Helvetica Neue', Helvetica, Arial, sans-serif";

var FONTS = [
  "Josefin Slab",
  "Vollkorn",
  "Lobster",
  "Playfair Display"
];

function textState(text){
  // Use random font
  var fontIndex = Math.round(Math.random() * FONTS.length);
  var fontFamily = FONTS[fontIndex] + ', ' + BASE_FONT;

  bigText
    .style('font-family', fontFamily)
    .text(text);
}

function textArt(text){
  // Use random font
  var fontIndex = Math.round(Math.random() * FONTS.length);
  var fontFamily = FONTS[fontIndex] + ', ' + BASE_FONT;

  // Use dummy text to compute actual width of the text
  // getBBox() will return bounding box

  // Generate the positions of the text in the background
  var xPtr = 0;
  var yPtr = 0;
  var positions = [];
  var rowCount = 0;
  if (text.length > 0){
  while(yPtr < height){
    while(xPtr < width){
    var nombre = d3.shuffle(text)[0]
    dummyText
        .style('font-family', fontFamily)
        .text(nombre);
    var bbox = dummyText.node().getBBox();

    var textWidth = bbox.width;
    var textHeight = bbox.height;
    var xGap = 3;
    var yGap = 1;

      var point = {
        text: nombre,
        index: positions.length,
        x: xPtr,
        y: yPtr
      };
      var dx = point.x - width/2 + textWidth/2;
      var dy = point.y - height/2;
      point.distance = dx*dx + dy*dy;

      positions.push(point);
      xPtr += textWidth + xGap;
    }
    rowCount++;
    xPtr = rowCount%2===0 ? 0 : -textWidth/2;
    xPtr += Math.random() * 10;
    yPtr += textHeight + yGap;
  }
}

  var selection = effectLayer.selectAll('text')
    .data(positions, function(d){return d.text+'/'+d.index;});

  // Clear old ones
  selection.exit().transition()
    .style('opacity', 0)
    .remove();

  // Create text but set opacity to 0
  selection.enter().append('text')
    .text(function(d){return d.text;})
    .attr('x', function(d){return d.x;})
    .attr('y', function(d){return d.y;})
    .style('font-family', fontFamily)
    .style('fill', '#777')
    .style('opacity', 0);

  selection
    .style('font-family', fontFamily)
    .attr('x', function(d){return d.x;})
    .attr('y', function(d){return d.y;});

  // Create transtion to increase opacity from 0 to 0.1-0.5
  // Add delay based on distance from the center of the <svg> and a bit more randomness.
  selection.transition()
    .delay(function(d){
      return d.distance * 0.01 + Math.random()*1000;
    })
    .style('opacity', function(d){
      return 0.1 + Math.random()*0.4;
    });
}

</script>